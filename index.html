<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        query, 
        onSnapshot, 
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const FIREBASE_CONFIG = {
        apiKey: "***REMOVED***",
        authDomain: "sanddollarsurvey2025.firebaseapp.com",
        projectId: "sanddollarsurvey2025",
        storageBucket: "sanddollarsurvey2025.firebasestorage.app",
        messagingSenderId: "980365100199",
        appId: "1:980365100199:web:5929df6358a25057e78782",
        measurementId: "G-ECY2YFY394"
    };
    
    const APP_ID = FIREBASE_CONFIG.projectId; 
    const COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/survey_responses`;

    let db;
    let auth;
    let userId = null;
    let RESEARCHER_USER_ID = null;
    let isAuthReady = false;

    const surveyContainer = document.getElementById('sandDollarSurveyForm');
    const viewResultsButton = document.getElementById('viewResultsButton');
    const resultsContainer = document.getElementById('survey-results-container') || (() => {
        const container = document.createElement('div');
        container.id = 'survey-results-container';
        container.className = 'hidden mt-10'; 
        document.querySelector('.max-w-3xl.mx-auto').appendChild(container);
        return container;
    })();
    
    const messageBox = document.getElementById('messageBox');
    const messageText = document.getElementById('messageText');
    const messageSubText = document.getElementById('messageSubText');
    const submitButton = document.getElementById('submitButton');

    function showMessage(type, message, subText = '') {
        messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-500', 'text-red-700', 'bg-yellow-100', 'border-yellow-500', 'text-yellow-700', 'bg-green-100', 'border-green-500', 'text-green-700');
        
        if (type === 'success') {
            messageBox.classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'border-l-4');
        } else if (type === 'error') {
            messageBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700', 'border-l-4');
        } else {
            messageBox.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-700', 'border-l-4');
        }

        messageText.textContent = message;
        messageSubText.textContent = subText;
        messageBox.classList.remove('hidden');

        // Auto-hide success messages after 10 seconds
        if (type === 'success') {
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 10000);
        }
    }

    function switchView(view) {
        if (view === 'survey') {
            surveyContainer.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            document.querySelector('header h1').textContent = "Sand Dollar Consumer Adoption Survey";
            viewResultsButton.textContent = "View Live Results (Researcher Only)";
            viewResultsButton.onclick = () => switchView('results');
        } else if (view === 'results') {
            surveyContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            document.querySelector('header h1').textContent = "Survey Results Dashboard";
            viewResultsButton.textContent = "Return to Survey Form";
            viewResultsButton.onclick = () => switchView('survey');
            
            if (RESEARCHER_USER_ID && userId === RESEARCHER_USER_ID) {
                setupRealtimeResults();
            }
        }
    }

    function initializeFirebase() {
        try {
            console.log("Initializing Firebase...");
            const app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const urlParams = new URLSearchParams(window.location.search);
            const researcherToken = urlParams.get('researcher_token');
            
            RESEARCHER_USER_ID = localStorage.getItem('researcher_user_id');

            if (researcherToken) {
                localStorage.setItem('researcher_user_id', researcherToken);
                RESEARCHER_USER_ID = researcherToken;
                console.log("Researcher token set from URL");
                
                const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated:", userId);
                    
                    if (RESEARCHER_USER_ID && userId === RESEARCHER_USER_ID) {
                        viewResultsButton.classList.remove('hidden');
                        console.log("Researcher mode enabled");
                    }
                } else {
                    console.log("No user found, signing in anonymously...");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        showMessage('error', 'Authentication Error', 'Please ensure localhost is in your Firebase authorized domains.');
                    }
                }
                isAuthReady = true;
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage('error', 'Initialization Error', 'Failed to initialize Firebase. Check console for details.');
        }
    }

    // Form submission handler
    surveyContainer.addEventListener('submit', async (e) => {
        e.preventDefault(); // This prevents the page refresh!
        
        console.log("Form submission started...");

        // Check consent first
        const consentValue = document.querySelector('input[name="consent"]:checked')?.value;
        if (consentValue === 'No') {
            showMessage('info', 'Thank you for your time!', 'You have opted not to participate in the survey.');
            return;
        }
        if (!consentValue) {
            showMessage('error', 'Consent Required', 'Please indicate whether you consent to participate in the survey.');
            return;
        }

        if (!isAuthReady || !db) {
            showMessage('error', 'Connection not ready.', 'Please wait a moment and try submitting again.');
            return;
        }

        // Show loading state
        const originalText = submitButton.textContent;
        submitButton.textContent = 'Submitting...';
        submitButton.disabled = true;

        try {
            const formData = new FormData(e.target);
            const responseData = {
                submittedBy: userId,
                timestamp: serverTimestamp(),
                consent: formData.get('consent'),
                gender: formData.get('gender'),
                age: formData.get('age'),
                employment: formData.get('employment'),
                education: formData.get('education'),
                q1_preference: parseInt(formData.get('q1_preference')),
                q2_acceptance: parseInt(formData.get('q2_acceptance')),
                q3_trust: parseInt(formData.get('q3_trust')),
                q4_general_incentive: parseInt(formData.get('q4_general_incentive')),
                q5_vat_credit: parseInt(formData.get('q5_vat_credit')),
                q6_switching: parseInt(formData.get('q6_switching')),
                q7_importance: parseInt(formData.get('q7_importance')),
            };

            console.log("Submitting data to Firestore...");
            await addDoc(collection(db, COLLECTION_PATH), responseData);
            
            console.log("Survey submitted successfully!");
            showMessage('success', 'Survey Submitted Successfully!', 'Thank you for your valuable contribution to the research.');
            
            // Reset form after successful submission
            setTimeout(() => {
                e.target.reset();
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                
                // Scroll to top to show the success message
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 2000);

        } catch (error) {
            console.error("Submission error:", error);
            showMessage('error', 'Submission Failed', 'There was an error saving your response. Please try again.');
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        }
    });

    // Results functionality
    const questionMapping = {
        gender: "A. Gender", 
        age: "B. Age Range", 
        employment: "C. Employment Status", 
        education: "D. Education",
        q1_preference: "1. Preference for Existing Methods", 
        q2_acceptance: "2. Merchant Acceptance", 
        q3_trust: "3. Trust and Privacy",
        q4_general_incentive: "4. General Receptivity", 
        q5_vat_credit: "5. Specific VAT Credit Impact", 
        q6_switching: "6. Switching Behavior", 
        q7_importance: "7. Importance of Financial Benefit",
    };

    const likertLabels = { 
        1: 'Strongly Disagree', 
        2: 'Disagree', 
        3: 'Neutral', 
        4: 'Agree', 
        5: 'Strongly Agree' 
    };
    
    const likertKeys = [
        'q1_preference', 'q2_acceptance', 'q3_trust', 
        'q4_general_incentive', 'q5_vat_credit', 'q6_switching', 'q7_importance'
    ];

    function calculateResults(responses) {
        const results = {
            totalResponses: responses.length,
            demographics: {},
            likert: {},
            averageLikert: 0,
        };

        const allLikertScores = [];

        responses.forEach(response => {
            ['gender', 'age', 'employment', 'education'].forEach(key => {
                const value = response[key] || 'N/A';
                results.demographics[key] = results.demographics[key] || { 
                    title: questionMapping[key], 
                    counts: {} 
                };
                results.demographics[key].counts[value] = (results.demographics[key].counts[value] || 0) + 1;
            });

            likertKeys.forEach(key => {
                const score = response[key];
                if (score && !isNaN(score)) {
                    allLikertScores.push(score);
                    results.likert[key] = results.likert[key] || { 
                        title: questionMapping[key], 
                        counts: {} 
                    };
                    
                    const label = likertLabels[score] || `Score ${score}`;
                    results.likert[key].counts[label] = (results.likert[key].counts[label] || 0) + 1;
                }
            });
        });

        if (allLikertScores.length > 0) {
            const sum = allLikertScores.reduce((acc, score) => acc + score, 0);
            results.averageLikert = (sum / allLikertScores.length).toFixed(2);
        }

        return results;
    }

    function renderResults(results) {
        if (resultsContainer.classList.contains('hidden')) return;

        let html = `
            <h2 class="text-2xl font-extrabold text-blue-600 mb-4">
                Live Survey Data (${results.totalResponses} Responses)
            </h2>
            
            <div class="bg-indigo-50 p-6 rounded-xl shadow-md mb-8">
                <p class="text-lg font-semibold text-indigo-800">Overall Likert Mean Score:</p>
                <p class="text-4xl font-bold text-indigo-900 mt-1">${results.averageLikert} / 5.00</p>
                <p class="text-sm text-indigo-600 mt-2">Based on all 7 Likert questions.</p>
            </div>
        `;

        html += `
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-t pt-4">
                Likert Questions Analysis
            </h3>
            <p class="text-sm text-gray-500 mb-6">
                Distribution of responses for adoption barriers and incentive receptivity.
            </p>
        `;

        Object.keys(results.likert).forEach(key => {
            const item = results.likert[key];
            html += `
                <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white">
                    <p class="font-semibold text-gray-800 mb-3">${item.title}</p>
            `;
            
            const sortedLabels = [1, 2, 3, 4, 5].map(score => likertLabels[score]);
            
            sortedLabels.forEach(label => {
                const count = item.counts[label] || 0;
                const percentage = results.totalResponses > 0 ? 
                    ((count / results.totalResponses) * 100).toFixed(1) : 0;
                const isStrong = label.includes('Strongly');
                
                html += `
                    <div class="flex items-center mb-2 text-sm">
                        <span class="w-1/3 text-gray-600 ${isStrong ? 'font-medium' : ''}">
                            ${label}:
                        </span>
                        <div class="w-2/3 h-5 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-5 rounded-full ${
                                isStrong ? 'bg-emerald-400' : 'bg-blue-400'
                            }" style="width: ${percentage}%; min-width: 0%;"></div>
                        </div>
                        <span class="ml-3 text-xs font-semibold text-gray-700 min-w-12">
                            ${percentage}% (${count})
                        </span>
                    </div>
                `;
            });
            html += `</div>`;
        });
        
        html += `
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-t pt-4">
                Demographic Breakdown
            </h3>
        `;
        
        Object.keys(results.demographics).forEach(key => {
            const item = results.demographics[key];
            html += `
                <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white">
                    <p class="font-semibold text-gray-800 mb-3">${item.title}</p>
            `;
            
            Object.keys(item.counts).sort().forEach(label => {
                const count = item.counts[label];
                const percentage = ((count / results.totalResponses) * 100).toFixed(1);
                
                html += `
                    <div class="flex items-center mb-2 text-sm">
                        <span class="w-1/3 text-gray-600">${label}:</span>
                        <div class="w-2/3 h-4 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-4 rounded-full bg-yellow-400" style="width: ${percentage}%;"></div>
                        </div>
                        <span class="ml-3 text-xs font-semibold text-gray-700 min-w-12">
                            ${percentage}% (${count})
                        </span>
                    </div>
                `;
            });
            html += `</div>`;
        });

        resultsContainer.innerHTML = html;
    }

    function setupRealtimeResults() {
        if (!db) {
            console.error("Firestore not initialized");
            return;
        }

        const q = query(collection(db, COLLECTION_PATH));
        
        onSnapshot(q, (snapshot) => {
            const responses = [];
            snapshot.forEach((doc) => {
                responses.push(doc.data());
            });

            console.log(`Received ${responses.length} responses`);
            
            if (responses.length > 0) {
                const results = calculateResults(responses);
                renderResults(results);
            } else {
                resultsContainer.innerHTML = `
                    <p class="text-lg text-gray-500 mt-6 p-4 bg-gray-50 rounded-lg">
                        No survey responses received yet.
                    </p>
                `;
            }
        }, (error) => {
            console.error("Snapshot error:", error);
            resultsContainer.innerHTML = `
                <p class="text-lg text-red-500 mt-6 p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                    Error loading results: ${error.message}
                </p>
            `;
        });
    }
    
    // Start the application
    window.addEventListener('DOMContentLoaded', initializeFirebase);
</script>
