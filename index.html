<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sand Dollar Consumer Adoption Survey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .likert-option {
            transition: all 0.2s;
        }
        .likert-option:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
        input[type="radio"]:checked + label {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }
        .required-field:after {
            content: " *";
            color: #ef4444;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-3xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-100">
        
        <!-- Exit Screen (Hidden by default) -->
        <div id="exitScreen" class="hidden text-center py-16">
            <div class="bg-green-50 border border-green-200 rounded-xl p-8 max-w-2xl mx-auto">
                <div class="text-6xl mb-4">âœ…</div>
                <h2 class="text-2xl font-bold text-green-800 mb-4">Thank You For Your Time</h2>
                <p class="text-green-700 mb-6">We respect your decision not to participate in the survey at this time.</p>
                <p class="text-green-600">Your privacy and consent are important to us. You may close this window now.</p>
            </div>
        </div>

        <!-- Main Survey Content -->
        <div id="surveyContent">
            <header class="mb-8 border-b pb-4">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Sand Dollar Consumer Adoption Survey</h1>
                <p class="text-lg text-gray-500">Academic Research Project: BUSI-951-01 Introduction to Financial Technologies (FinTech) in Financial Services Fall 2025</p>
            </header>

            <div class="mb-10 p-6 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                <h2 class="text-xl font-semibold text-blue-800 mb-3">Introduction from the Researcher</h2>
                <p class="text-gray-700 leading-relaxed">Dear Participant,</p>
                <p class="text-gray-700 leading-relaxed mt-2">My name is <strong>Renee Darling Neymour</strong>, and I am a student in the <strong>BUSI-951-01 Introduction to Financial Technologies (FinTech) in Financial Services Fall 2025</strong> class.</p>
                <p class="text-gray-700 leading-relaxed mt-2">I am conducting this anonymous survey as part of an academic research project focused on digital currency adoption barriers in The Bahamas.</p>
                <p class="text-gray-700 leading-relaxed mt-2 font-medium">Your participation is incredibly valuable. Please be assured that all responses are strictly confidential and the results will <strong>only</strong> be used for the purpose of this research paper.</p>
                <p class="text-gray-700 leading-relaxed mt-2">Thank you for taking the time to complete this survey.</p>
            </div>

            <form id="sandDollarSurveyForm" class="space-y-10">
                <!-- Consent Section -->
                <section id="section-consent">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Start of Survey: Consent</h3>
                    <p class="text-base text-gray-600 mb-4">0.0. Permission to Complete Survey</p>
                    <p class="text-sm italic text-gray-500 mb-6">This anonymous survey is for academic research only and is designed to assess public attitudes toward digital currency incentives in The Bahamas. Your responses will be kept confidential and used solely for this research paper. Do you agree to participate in this survey?</p>
                    <div class="flex flex-wrap gap-4">
                        <input type="radio" id="consent_yes" name="consent" value="Yes" class="hidden">
                        <label for="consent_yes" class="px-6 py-3 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">Yes, I consent to participate</label>
                        <input type="radio" id="consent_no" name="consent" value="No" class="hidden">
                        <label for="consent_no" class="px-6 py-3 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">No, I do not consent</label>
                    </div>
                </section>

                <!-- Rest of your survey form remains the same -->
                <!-- ... (all your existing survey questions) ... -->

                <!-- Validation Message -->
                <div id="validationMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-red-700 font-medium">Please complete all required questions before submitting the survey.</p>
                    <p class="text-red-600 text-sm mt-1">All questions marked with * are required.</p>
                </div>

                <!-- Submit Button & View Results -->
                <div class="border-t pt-6 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <button type="submit" id="submitButton" class="w-full sm:w-1/2 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/50">
                        Submit Survey
                    </button>
                    <button type="button" id="viewResultsButton" class="hidden w-full sm:w-1/2 bg-gray-200 text-gray-800 font-bold py-3 rounded-xl hover:bg-gray-300 transition-colors">
                        View Live Results (Researcher Only)
                    </button>
                </div>
                
                <!-- Message Box -->
                <div id="messageBox" class="p-4 mt-6 hidden" role="alert">
                    <p id="messageText" class="font-medium"></p>
                    <p class="text-sm mt-1" id="messageSubText"></p>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const FIREBASE_CONFIG = {
            apiKey: "***REMOVED***",
            authDomain: "sanddollarsurvey2025.firebaseapp.com",
            projectId: "sanddollarsurvey2025",
            storageBucket: "sanddollarsurvey2025.firebasestorage.app",
            messagingSenderId: "980365100199",
            appId: "1:980365100199:web:5929df6358a25057e78782",
            measurementId: "G-ECY2YFY394"
        };
        
        const APP_ID = FIREBASE_CONFIG.projectId; 
        const COLLECTION_PATH = `/artifacts/${APP_ID}/public/data/survey_responses`;

        let db;
        let auth;
        let userId = null;
        let RESEARCHER_USER_ID = null;
        let isAuthReady = false;

        // DOM Elements
        const surveyContainer = document.getElementById('sandDollarSurveyForm');
        const surveyContent = document.getElementById('surveyContent');
        const exitScreen = document.getElementById('exitScreen');
        const viewResultsButton = document.getElementById('viewResultsButton');
        const validationMessage = document.getElementById('validationMessage');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageSubText = document.getElementById('messageSubText');
        const submitButton = document.getElementById('submitButton');
        const consentNo = document.getElementById('consent_no');
        const consentYes = document.getElementById('consent_yes');

        // 1. EXIT SCREEN FUNCTIONALITY
        function showExitScreen() {
            console.log("Showing exit screen");
            surveyContent.classList.add('hidden');
            exitScreen.classList.remove('hidden');
        }

        // Listen for "No consent" selection
        if (consentNo) {
            consentNo.addEventListener('change', function() {
                if (this.checked) {
                    console.log("No consent selected - showing exit screen");
                    showExitScreen();
                }
            });
        }

        // 2. FORM VALIDATION FUNCTION
        function validateForm() {
            console.log("Validating form...");
            
            // Check consent first
            const consentValue = document.querySelector('input[name="consent"]:checked')?.value;
            if (!consentValue || consentValue === 'No') {
                console.log("Consent validation failed");
                return false;
            }

            // List of all required field names
            const requiredFields = [
                'gender', 'age', 'employment', 'education',
                'q1_preference', 'q2_acceptance', 'q3_trust',
                'q4_general_incentive', 'q5_vat_credit', 'q6_switching', 'q7_importance'
            ];

            // Check each required field
            for (const fieldName of requiredFields) {
                const field = document.querySelector(`input[name="${fieldName}"]:checked`);
                if (!field) {
                    console.log(`Missing field: ${fieldName}`);
                    return false;
                }
            }

            console.log("Form validation passed");
            return true;
        }

        function showValidationError() {
            validationMessage.classList.remove('hidden');
            validationMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Hide validation message after 5 seconds
            setTimeout(() => {
                validationMessage.classList.add('hidden');
            }, 5000);
        }

        function showMessage(type, message, subText = '') {
            messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-500', 'text-red-700', 'bg-yellow-100', 'border-yellow-500', 'text-yellow-700', 'bg-green-100', 'border-green-500', 'text-green-700');
            
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'border-l-4');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-500', 'text-red-700', 'border-l-4');
            } else {
                messageBox.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-700', 'border-l-4');
            }

            messageText.textContent = message;
            messageSubText.textContent = subText;
            messageBox.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 10000);
            }
        }

        // 3. FORM SUBMISSION HANDLER
        surveyContainer.addEventListener('submit', async (e) => {
            e.preventDefault(); // PREVENTS PAGE REFRESH
            console.log("Form submission started");

            // Validate form before submission
            if (!validateForm()) {
                showValidationError();
                return;
            }

            // Check if user selected "No consent"
            const consentValue = document.querySelector('input[name="consent"]:checked')?.value;
            if (consentValue === 'No') {
                showExitScreen();
                return;
            }

            if (!isAuthReady || !db) {
                showMessage('error', 'Connection not ready.', 'Please wait a moment and try submitting again.');
                return;
            }

            // Show loading state
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Submitting...';
            submitButton.disabled = true;

            try {
                const formData = new FormData(e.target);
                const responseData = {
                    submittedBy: userId,
                    timestamp: serverTimestamp(),
                    consent: formData.get('consent'),
                    gender: formData.get('gender'),
                    age: formData.get('age'),
                    employment: formData.get('employment'),
                    education: formData.get('education'),
                    q1_preference: parseInt(formData.get('q1_preference')),
                    q2_acceptance: parseInt(formData.get('q2_acceptance')),
                    q3_trust: parseInt(formData.get('q3_trust')),
                    q4_general_incentive: parseInt(formData.get('q4_general_incentive')),
                    q5_vat_credit: parseInt(formData.get('q5_vat_credit')),
                    q6_switching: parseInt(formData.get('q6_switching')),
                    q7_importance: parseInt(formData.get('q7_importance')),
                };

                console.log("Submitting to Firestore...");
                await addDoc(collection(db, COLLECTION_PATH), responseData);
                
                console.log("Survey submitted successfully!");
                showMessage('success', 'Survey Submitted Successfully!', 'Thank you for your valuable contribution to the research.');
                
                // Reset form after successful submission
                setTimeout(() => {
                    surveyContainer.reset();
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 2000);

            } catch (error) {
                console.error("Submission error:", error);
                showMessage('error', 'Submission Failed', 'There was an error saving your response. Please try again.');
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });

        // Firebase initialization
        function initializeFirebase() {
            try {
                console.log("Initializing Firebase...");
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const urlParams = new URLSearchParams(window.location.search);
                const researcherToken = urlParams.get('researcher_token');
                
                RESEARCHER_USER_ID = localStorage.getItem('researcher_user_id');

                if (researcherToken) {
                    localStorage.setItem('researcher_user_id', researcherToken);
                    RESEARCHER_USER_ID = researcherToken;
                    console.log("Researcher token set from URL");
                    
                    const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        
                        if (RESEARCHER_USER_ID && userId === RESEARCHER_USER_ID) {
                            viewResultsButton.classList.remove('hidden');
                            console.log("Researcher mode enabled");
                        }
                    } else {
                        console.log("No user found, signing in anonymously...");
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                            showMessage('error', 'Authentication Error', 'Please ensure localhost is in your Firebase authorized domains.');
                        }
                    }
                    isAuthReady = true;
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage('error', 'Initialization Error', 'Failed to initialize Firebase. Check console for details.');
            }
        }

        // Start the application
        window.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
